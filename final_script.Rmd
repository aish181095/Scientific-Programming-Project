---
---
title: "Scientific Programming project"
output: html_document
author:Aishwarya Iyer
date:
---
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#Set up the working directory
DATA.DIR    <- "C:\\Users\\HP\\Desktop\\scientific programming"
RESULTS.DIR <-  "C:\\Users\\HP\\Desktop\\scientific programming"
setwd(DATA.DIR)

##Import imputed dataset
imputed_data_1<-read.csv("imputed data 1.csv")



```{r}
##Merging classes into one 
#imputed data 1
imputed_data_1$Mild_Severity<- 2*(imputed_data_1$Mild_Severity)
imputed_data_1$Moderate_Severity<-3*(imputed_data_1$Moderate_Severity)
imputed_data_1$Severe<-4*(imputed_data_1$Severe)
#combine data
imputed_data_1$class<-as.factor(imputed_data_1$Mild_Severity+imputed_data_1$Moderate_Severity+imputed_data_1$No_Severity+imputed_data_1$Severe)
imputed_data_1$Mild_Severity<-NULL
imputed_data_1$Moderate_Severity<-NULL
imputed_data_1$No_Severity<-NULL
imputed_data_1$Severe<-NULL
levels(imputed_data_1$class) <- c("No_Severity", "Mild_Severity", "Moderate_Severity","Severity")
```

```{r}
# summarize the class distribution
percentage <- prop.table(table(imputed_data_1$class)) * 100
cbind(freq=table(imputed_data_1$class), percentage=percentage)
```

```{r}
library(caret)
set.seed(100)
index <- createDataPartition(imputed_data_1$class, p = 0.7, list = FALSE)
train_data <- imputed_data_1[index, ]
test_data  <- imputed_data_1[-index, ]

set.seed(101)
validation_index<-createDataPartition(train_data$class, p = 0.7, list = FALSE)
train_data <- train_data[validation_index, ]
validation_data  <- train_data[-validation_index, ]
```

```{r}
#summarise training dataset labels
percentage <- prop.table(table(train_data$class)) * 100
cbind(freq=table(train_data$class), percentage=percentage)

```


```{r}
##Optimising number of trees 
model_grid_trees <- expand.grid(
  num.trees=c(50,100,500,1000,2000)
  
  )

# total number of combinations
nrow(model_grid_trees)
```

```{r}
set.seed(34)
for(i in 1:nrow(model_grid_trees)) {
# Fit a model
model_opt_trees <- caret::train(as.factor(class) ~ ., data = train_data,
                     method = "ranger",
                     num.trees = model_grid_trees$num.trees[i],
                     importance = "impurity",
                     trControl = trainControl(method = "oob", number = 3))
}
save(model_opt_trees,file="model_opt_trees.RData")
```

```{r}
plot(model_opt_trees)
```

```{r}
#optimising mtry (number of variables)
# hyperparameter grid search
model_grid_mtry <- expand.grid(
  mtry      = c(1,4,5,10,14,20),
  splitrule="gini",
  min.node.size  = c(1000)
  
  )

# total number of combinations
nrow(model_grid_mtry)
## [1] 96
```

```{r}
set.seed(34)
# Fit a model
model_opt_mtry <- caret::train(class ~ ., data = train_data,
                     method = "ranger",
                     tuneGrid = model_grid_mtry,
                     num.trees = 1000,
                     importance = "impurity",
                     trControl = trainControl(method = "oob", number = 3))
save(model_opt_mtry,file="model_opt_mtry.RData")


```

```{r}
model_opt_mtry$bestTune
plot(model_opt_mtry)
```

```{r}
#optimising minimum number of nodes
# hyperparameter grid search
model_grid_nodes <- expand.grid(
  mtry      = c(1),
  splitrule="gini",
  min.node.size  = c(500,1000,2000,5000,10000,20000,50000,100000,150000)
  
  )

# total number of combinations
nrow(model_grid_nodes)
```

```{r}
set.seed(34)
# Fit a model
model_opt_nodes <- caret::train(class~ ., data = train_data,
                     method = "ranger",
                     tuneGrid = model_grid_nodes,
                     num.trees = 1000,
                     importance = "impurity",
                     trControl = trainControl(method = "oob", number = 3))
save(model_opt_nodes,file="model_opt_nodes.RData")


```

```{r}
model_opt_nodes$bestTune
plot(model_opt_nodes)
```

```{r}
#optimising minimum number of nodes
# hyperparameter grid search
model_opt_parameters <- expand.grid(
  mtry      = c(1),
  splitrule="gini",
  min.node.size  = c(100000)
  
  )

# total number of combinations
nrow(model_opt_parameters)
```

```{r}
set.seed(34)
# Fit a model
levels(train_data$class) <- c("No_Severity", "Mild_Severity", "Moderate_Severity","Severity")
optimised_model <- caret::train(class ~ ., data = train_data,
                     method = "ranger",
                     tuneGrid = model_opt_parameters,
                     num.trees = 1000,
                     importance = "impurity",
                     metric="Accuracy",
                     trControl = trainControl(method = "cv", number = 3,savePredictions = T,classProbs = T))
save(optimised_model,file="optimised_model.RData")


```

```{r}
#variable importance for classification
classification_importance<-varImp(optimised_model,scale = FALSE)

plot(classification_importance)
```

```{r}
#predicting validation test
predict_validation<-predict(optimised_model,validation_data,type="prob")
predict_valid<-predict(optimised_model,validation_data)
```

```{r}
No_sev_validation<-multiclass.roc(validation_data$class, predict_validation$No_Severity,percent = T) # Draw ROC curve.
Mild_sev_validation<-multiclass.roc(validation_data$class, predict_validation$Mild_Severity,percent = T) # Draw ROC curve.
Mod_sev_validation<-multiclass.roc(validation_data$class, predict_validation$Moderate_Severity,percent = T) # Draw ROC curve.
sev_validation<-multiclass.roc(validation_data$class, predict_validation$Severity,percent = T) # Draw ROC curve.
No_sev_validation<-roc(combined_class_pred$No_Severity_true, predict_validation$No_Severity,percent = T) # Draw ROC curve.
No_sev_score <- No_sev_validation[['rocs']]
Mild_sev_score  <- Mild_sev_validation[['rocs']]
Mod_sev_score  <- Mod_sev_validation[['rocs']]
sev_score  <- sev_validation[['rocs']]
```


```{r}
plot.roc(No_sev_score[[1]])
sapply(2:length(No_sev_score),function(i) lines.roc(No_sev_score[[i]],col=i))
legend()
```

```{r}
plot.roc(Mild_sev_score[[1]])
sapply(2:length(Mild_sev_score),function(i) lines.roc(Mild_sev_score[[i]],col=i))

```

```{r}
plot.roc(Mod_sev_score[[1]])
sapply(2:length(Mod_sev_score),function(i) lines.roc(Mod_sev_score[[i]],col=i))

```

```{r}
plot.roc(sev_score[[1]])
sapply(2:length(sev_score),function(i) lines.roc(sev_score[[i]],col=i))

```

```{r}
#plotting the confusion matrix to compare the predicted and reference output for the test data
table <- data.frame(confusionMatrix(table(predict_valid,validation_data[,24]))$table)
colnames(table)<-c("Observed","Prediction","Freq")
plotTable <- table %>%
  mutate(goodbad = ifelse(table$Prediction == table$Observed, "good", "bad")) %>%
  group_by(Observed) %>%
  mutate(prop = Freq/sum(Freq))

ggplot(data = plotTable, mapping = aes(x = Observed, y = Prediction, fill = goodbad, alpha = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), vjust = .5, fontface  = "bold", alpha = 1) +
  scale_fill_manual(values = c(good = "blue", bad = "yellow")) +
  theme_bw() +
  xlim(rev(levels(table$Observed)))

```

```{r}

#change levels in validation class
levels(test_data$class) <- c("No_Severity", "Mild_Severity", "Moderate_Severity","Severity")
#predicting validation test
predict_test_prob<-predict(optimised_model,test_data,type="prob")
predict_test<-predict(optimised_model,test_data)

roc_multiclass_test<-multiclass.roc(test_data$class,predict_test_prob$No_Severity,percent = T) # Draw ROC curve.
score_test <- roc_multiclass_test[['rocs']]
```

```{r}
plot.roc(score_test[[1]])
sapply(2:length(score_test),function(i) lines.roc(score_test[[i]],col=i))

```

```{r}
#plotting the confusion matrix to compare the predicted and reference output for the test data
table <- data.frame(confusionMatrix(table(predict_test,test_data[,24]))$table)
colnames(table)<-c("Observed","Prediction","Freq")
plotTable <- table %>%
  mutate(goodbad = ifelse(table$Prediction == table$Observed, "good", "bad")) %>%
  group_by(Observed) %>%
  mutate(prop = Freq/sum(Freq))

ggplot(data = plotTable, mapping = aes(x = Observed, y = Prediction, fill = goodbad, alpha = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), vjust = .5, fontface  = "bold", alpha = 1) +
  scale_fill_manual(values = c(good = "blue", bad = "yellow")) +
  theme_bw() +
  xlim(rev(levels(table$Observed)))

```
